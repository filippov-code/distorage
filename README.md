# distorage - система децентрализованного хранения файлов
Децентрализованное хранилище направленное на повышение надёжности хранения исключающая наличие управляющих узлов как потенциальных точек отказа.

Система представляет собой сеть равноправных узлов, каждый из которых способен независимо выполнять основные функции хранения, передачи и восстановления данных. Узлы взаимодействуют между собой напрямую, без привлечения центральных координационных серверов или управляющих компонентов.

## Архитектура
### Приложение (App)
Приложение является центральной управляющей частью узла. Оно координирует работу всех внутренних компонентов, обрабатывает запросы от других узлов и управляет процессами хранения, передачи и восстановления данных. Приложение реализует бизнес-логику взаимодействия как внутри узла, так и с внешней сетью, определяет поведение узла при изменении состояния сети, обработке ошибок и появлении новых данных.
В качестве языка программирования в проекте был выбран Go.

### База данных (DB)
База данных предназначена для хранения служебной информации, связанной с функционированием узла и участием его в общей сети хранения данных. Она позволяет сохранять сведения о состоянии системы и обеспечивает доступ к важной информации при обработке запросов приложением, восстановления данных и синхронизации с другими узлами.
В качестве базы данных в проекте была выбрана MongoDB.

### Файловое хранилище (Storage)
Файловое хранилище отвечает за фактическое хранение файлов и их реплик. Оно обеспечивает сохранность данных, их приём и передачу по запросу приложения.
В качестве хранилища файлов в проекте была выбрана MinIO.

![node](https://github.com/filippov-code/distorage/blob/main/readme-images/node.png)

Сеть из 3 узлов

![network](https://github.com/filippov-code/distorage/blob/main/readme-images/network.png)

### Gateway
Кроме основных узлов системы, есть дополнительный компонент — Gateway-сервис. Gateway предназначен для приёма запросов от конечных пользователей и передачи их в сеть распределённых узлов. Он выступает в роли входной точки в систему, упрощая процесс загрузки и получения файлов без необходимости непосредственного участия пользователей в работе протоколов внутренней сети.

Gateway-сервис связан с одним из узлов сети, к которому он прикреплён. При этом наличие Gateway-сервиса является необязательным для каждого узла.

Кроме базовых функций проксирования, Gateway может также выполнять дополнительные задачи, направленные на повышение устойчивости и безопасности системы. Среди них:
- балансировка нагрузки между несколькими внутренними узлами или кластерами узлов
- аутентификация и авторизация пользователей перед допуском к ресурсам системы
- мониторинг и ограничение трафика, защита от перегрузок и несанкционированного доступа
- кэширование популярных данных для снижения нагрузки на внутреннюю сеть

![gateway](https://github.com/filippov-code/distorage/blob/main/readme-images/gateway.png)

### Межузловое взаимодействие
В качестве способа связи между улами в проекте был выбран gRPC.

## Функции

### Автоматическое восстановления после отказа узла

![recovery](https://github.com/filippov-code/distorage/blob/main/readme-images/recovery.png)

### Поддержка конкурентных обновлений и удалений файлов
(спроектировано)

![update](https://github.com/filippov-code/distorage/blob/main/readme-images/update.png)

### Дополнительные функции
- Все CRUD операции
- Функция автоматического реплицирования файлов
- Функция динамического присоединения новых узлов к сети и их синхронизация

## Использование

### node
Проект node представлет собой один из узлов сети. 
Для запуска узла необходимо передать следующие параметры:
- `port` Порт для запуска gRPC сервера
- `url` Адрес по которому узел будет доступен в сети
- `mongo` Строка подключения к MongoDB
- `minio` Строка подключения к MinIO
- `boot` Адрес ноды, которая будет использована для подключения к сети (не используется для первого узла)

Пример команды запуска первого узла:

```powershell
go run main.go --port=4001 --url=localhost:4001 --mongo=mongodb://root:example@localhost:27001 --minio=minio://minioadmin:minioadmin123@localhost:9010
```

Пример команды запуска остальных узлов:

```powershell
go run main.go --port=4002 --url=localhost:4002 --mongo=mongodb://root:example@localhost:27002 --minio=minio://minioadmin:minioadmin123@localhost:9020 --boot=localhost:4001
```

### gateway
Проект gateway представляет собой Gateway-сервис который связывается с одним из узлов сети. Это http-сервер который принимает http запросы и проксирует их узлу, который обработает запрос внутри сети.
Для запуска gateway необходимо передать следующие параметры:
- `port` Порт для запуска HTTP сервера
- `node` Адрес узла на который нужно проксировать запросы

Пример команды запуска:

```powershell
go run main.go --port=4011 --node=localhost:4002
```

### Примеры запросов к Gateway

POST /files
```curl
curl --location 'http://localhost:4011/files' \
--form 'file=@"/F:/Downloads/cat_in_the_hat.png"'
```

DELETE /files/{id}
```curl
curl --location --request DELETE 'http://localhost:4011/files/6cfd362a-8ba5-42b6-93f3-7cc01406357c'
```

GET /files/{id}
```curl
curl --location 'http://localhost:4011/files/6cfd362a-8ba5-42b6-93f3-7cc01406357c'
```

PUT /files/{id}
```curl
curl --location --request PUT 'http://localhost:4011/files/6cfd362a-8ba5-42b6-93f3-7cc01406357c' \
--header 'Content-Type: application/json' \
--data '{
    "filename" : "cat_in_the_cap.png"
}'
```



